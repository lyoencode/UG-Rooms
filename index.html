<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beranda - UG Room</title>
    <link rel="icon" href="assets/images/Logo-Gunadarma-Universitas-Gunadarma-Original-PNG-1140x1175 1.png" type="image/png">
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
    <script type="importmap">
{
    "imports": {
      "@google/generative-ai": "https://esm.run/@google/generative-ai@0.1.3"
    }
}
</script>
</head>
<body>

    <nav class="navbar">
        <div class="container nav-container">
            <a href="index.html" class="nav-brand">
                <img src="assets/images/Logo gundar untuk navigation bar.png" alt="Logo Gunadarma">
            </a>

            <ul class="nav-menu">
                <li><a href="index.html" class="active" style="color: var(--primary-color);">Beranda</a></li>
                <li><a href="pages/pesan-kelas.html">Pesan Kelas</a></li>
                <li><a href="pages/info-kelas.html">Info Kelas</a></li>
                <li><a href="pages/jadwal-kuliah.html">Jadwal Kuliah</a></li>
                <li><a href="pages/bantuan.html">Bantuan</a></li>
            </ul>

            <div style="display: flex; align-items: center;">
                <div class="nav-search">
                    <i class="fas fa-search" style="cursor: pointer;" onclick="handleGlobalSearch()"></i>
                    <input type="text" id="globalSearchInput" placeholder="Cari Kelas..." onkeypress="if(event.key === 'Enter') handleGlobalSearch()">
                </div>
                <a href="pages/login.html" class="btn-login" id="authBtn">
                    Login <i class="fas fa-sign-in-alt"></i> 
                </a>
            </div>
        </div>
    </nav>

    <section class="hero-section">
        <div class="container hero-grid">
            
            <div class="hero-card-left">
                <div class="hero-title-group">
                    <div class="ug-room-logo">
                        <span class="text-u">U</span><span class="text-g">G</span>
                    </div>
                    <span class="ug-room-text">Room</span>
                    <img src="assets/images/logo ug room.png" alt="3D Icon" class="hero-icon-3d">
                </div>

                <p class="hero-desc">
                    Kelola kebutuhan ruang kelas dengan mudah. Cek ketersediaan dan lakukan pemesanan dalam satu tempat.
                </p>

                <div class="hero-buttons">
                    <a href="javascript:void(0)" class="btn-admin" onclick="openHelpdesk()">
                        Hubungi Admin <i class="fas fa-comment-dots" style="margin-left:8px;"></i>
                    </a>

                    <a href="pages/info-kelas.html" class="btn-list">
                        Lihat Daftar Kelas <i class="fas fa-arrow-right" style="margin-left:8px;"></i>
                    </a>
                </div>
            </div>

            <div class="hero-card-right-stack">
    
                <div class="stat-card-floating red-accent">
                    <div class="icon-wrapper icon-bg-red">
                        <i class="far fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h4>Jam Aktif</h4>
                        <p class="text-red">07.30 - 16.30</p>
                    </div>
                </div>

                <div class="stat-card-floating blue-accent">
                    <div class="icon-wrapper icon-bg-blue">
                        <i class="far fa-calendar-check"></i>
                    </div>
                    <div class="stat-info">
                        <h4>Reservasi Hari Ini</h4>
                        <p class="text-blue">3</p>
                    </div>
                </div>

                <div class="stat-card-floating green-accent">
                    <div class="icon-wrapper icon-bg-green">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                    <div class="stat-info">
                        <h4>Ruang Tersedia</h4>
                        <p class="text-green">10</p>
                    </div>
                </div>

            </div>

        </div>
    </section>


    <div class="helpdesk-widget" id="helpdeskWidget">
        
        <div class="widget-content-scroll">
            
            <div id="viewHome">
                <div class="header-home">
                    <button class="btn-header-action" onclick="closeHelpdesk()" style="position: absolute; right: 20px; top: 20px;">
                        <i class="fas fa-times"></i>
                    </button>
                    <h3 class="dash-title">Helpdesk UG ROOM</h3>
                    <p class="dash-subtitle">Waktu Operasional Senin, Rabu, Kamis, dan Jumat (05.00-14.00 WIB)</p>
                </div>

                <div class="home-overlap-container">
                    <div class="card-new-chat" onclick="goToChatRoom()">
                        <div class="card-text">
                            <h4>Percakapan Baru</h4>
                            <p>Membalas dalam beberapa menit</p>
                        </div>
                        <i class="fas fa-paper-plane icon-send-purple"></i>
                    </div>
                </div>
            </div>

            <div id="viewHistory" style="display: none;">
                <div class="header-history">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button class="btn-header-action" onclick="switchTab('home')"><i class="fas fa-chevron-left"></i></button>
                        <span>Percakapan</span>
                    </div>
                    <button class="btn-header-action" onclick="closeHelpdesk()"><i class="fas fa-times"></i></button>
                </div>

                <div class="history-container">
                    <span class="label-section">Mulai percakapan baru</span>
                    
                    <div class="card-new-chat" onclick="goToChatRoom()">
                        <div class="card-text">
                            <h4>Percakapan Baru</h4>
                            <p>Membalas dalam beberapa menit</p>
                        </div>
                        <i class="fas fa-paper-plane icon-send-purple"></i>
                    </div>

                    <span class="label-section">Terbaru</span>

                    <div class="history-item" onclick="goToChatRoom()">
                        <div class="history-item-top">
                            <span class="history-role">Helpdesk UG ROOM</span>
                            <span class="history-time">sekarang</span>
                        </div>
                        <div class="history-preview">
                            <span>Selamat datang di layanan UG...</span>
                            <i class="fas fa-chevron-right icon-arrow-right"></i>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="widget-footer" id="mainFooter">
            <button class="nav-btn active" id="btnHome" onclick="switchTab('home')">
                <i class="fas fa-home"></i>
            </button>
            <button class="nav-btn" id="btnHistory" onclick="switchTab('history')">
                <i class="far fa-comment-alt"></i>
            </button>
        </div>

        <div class="screen-chat-room" id="viewChatRoom">
            <div class="room-header">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-robot"></i> <strong>UG Room Assistant</strong>
                </div>
                <button class="btn-header-action" onclick="closeHelpdesk()"><i class="fas fa-times"></i></button>
            </div>
            <div class="room-body">
                <div class="bubble-bot">Halo! ðŸ‘‹ Ada yang bisa saya bantu?</div>
            </div>
            <div class="room-footer">
                <input type="text" class="input-chat" placeholder="Ketik pesan...">
                <button class="btn-chat-send"><i class="fas fa-paper-plane"></i></button>
            </div>
            <div style="text-align: center; padding: 10px;">
                <span style="font-size: 0.8rem; color: #999; cursor: pointer; text-decoration: underline;" onclick="exitChatRoom()">Kembali</span>
            </div>
        </div>

    </div>

    <script>
        // --- GLOBAL SEARCH LOGIC ---
        function handleGlobalSearch() {
            const input = document.getElementById('globalSearchInput');
            const keyword = input.value.trim();

            if (keyword) {
                // Karena kita di root (index.html), arahkan ke pages/pesan-kelas.html
                const targetUrl = 'pages/pesan-kelas.html?q=' + encodeURIComponent(keyword);
                window.location.href = targetUrl;
            }
        }

        // --- HELPDESK WIDGET UI LOGIC ---
        const viewHome = document.getElementById('viewHome');
        const viewHistory = document.getElementById('viewHistory');
        const viewChatRoom = document.getElementById('viewChatRoom');
        const mainFooter = document.getElementById('mainFooter');
        const btnHome = document.getElementById('btnHome');
        const btnHistory = document.getElementById('btnHistory');

        function switchTab(tab) {
            if (tab === 'home') {
                viewHome.style.display = 'block';
                viewHistory.style.display = 'none';
                btnHome.classList.add('active');
                btnHistory.classList.remove('active');
                btnHome.innerHTML = '<i class="fas fa-home"></i>';
                btnHistory.innerHTML = '<i class="far fa-comment-alt"></i>'; 
            } else {
                viewHome.style.display = 'none';
                viewHistory.style.display = 'block';
                btnHome.classList.remove('active');
                btnHistory.classList.add('active');
                btnHome.innerHTML = '<i class="fas fa-home" style="opacity:0.5"></i>';
                btnHistory.innerHTML = '<i class="fas fa-comment-alt"></i>'; 
            }
        }

        function goToChatRoom() {
            viewChatRoom.style.display = 'flex';
        }

        function exitChatRoom() {
            viewChatRoom.style.display = 'none';
            switchTab('home');
        }

        function openHelpdesk() {
            document.getElementById('helpdeskWidget').style.display = 'flex';
            switchTab('home'); 
        }

        function closeHelpdesk() {
            document.getElementById('helpdeskWidget').style.display = 'none';
        }

        // --- NAVBAR & LOGOUT LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            // Cek Login
            const isLoggedIn = localStorage.getItem("isLoggedIn");
            const userName = localStorage.getItem("userName");
            const authBtn = document.getElementById('authBtn');

            if (isLoggedIn === "true" && authBtn) {
                const firstName = userName.split(" ")[0]; 
                authBtn.innerHTML = `${firstName} <i class="fas fa-sign-out-alt"></i>`;
                authBtn.style.backgroundColor = "#E74C3C"; // Merah
                authBtn.href = "#"; 
                authBtn.onclick = function(e) {
                    e.preventDefault();
                    handleLogout();
                };
            }
        });

        function handleLogout() {
            if(confirm("Apakah Anda yakin ingin keluar?")) {
                localStorage.removeItem("isLoggedIn");
                localStorage.removeItem("userName");
                window.location.reload(); 
            }
        }
    </script>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // 1. KONFIGURASI GEMINI
        // GANTI INI DENGAN API KEY ANDA YANG VALID
        const API_KEY = "AIzaSyA7QYmbA5vafAx4pbRZMho1-O8e12Jg4Tw"; 
        const genAI = new GoogleGenerativeAI(API_KEY);
        
        // --- KONTEKS & DATA UNTUK AI ---
        const systemInstruction = `
            Kamu adalah Asisten Virtual 'UG Room' untuk Universitas Gunadarma.
            Target pengguna: Dosen.
            Gaya bahasa: Sopan, Formal, tapi membantu (Bahasa Indonesia).
            
            Tugasmu:
            1. Menjawab pertanyaan seputar cara booking kelas.
            2. Memberikan info jadwal (berdasarkan data di bawah).
            3. Jika ditanya hal diluar kampus, tolak dengan halus.

            DATA JADWAL KULIAH SAAT INI (Simulasi):
            - Senin: Fitrianingsih (D281, 07.30), Hengky (K152, 07.30), Taufik (K262, 10.30).
            - Selasa: Muhamad Taufan (K292, 07.30), Muhammad Mudjib (K258, 09.30), Agus Sulaksono (K242, 09.30), Miftah (K274, 08.30).
            - Rabu: Taufik Hidayat (J101, 08.30).
            - Status Ruang: K132 (Lab Komputer), D281 (Kelas Teori).
            - Cara Booking: Login -> Pilih Menu Pesan Kelas -> Pilih Ruang & Jam -> Klik Reservasi.
        `;

        const model = genAI.getGenerativeModel({ 
            model: "gemini-1.5-flash",
            systemInstruction: systemInstruction
        });

        let chatSession;

        // Fungsi Memulai Chat Baru
        async function startChat() {
            try {
                chatSession = model.startChat({
                    history: [
                        {
                            role: "user",
                            parts: [{ text: "Halo" }],
                        },
                        {
                            role: "model",
                            parts: [{ text: "Halo! Saya asisten UG Room. Ada yang bisa saya bantu terkait jadwal atau pemesanan kelas?" }],
                        },
                    ],
                });
            } catch (e) {
                console.error("Gagal inisialisasi chat:", e);
            }
        }

        // --- LOGIKA UI CHATBOT (HANDLING PESAN) ---
        const chatInput = document.querySelector('.input-chat');
        const sendBtn = document.querySelector('.btn-chat-send');
        const chatBody = document.querySelector('.room-body');

        // 1. Fungsi Kirim Pesan
        async function handleChat() {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            // Tampilkan Pesan User
            appendMessage(userMessage, 'user');
            chatInput.value = ''; // Kosongkan input
            
            // Tampilkan Loading (Typing...)
            const loadingId = showLoading();

            try {
                if (!chatSession) await startChat();
                
                // Kirim ke Gemini
                const result = await chatSession.sendMessage(userMessage);
                const response = await result.response;
                const text = response.text();

                // Hapus Loading & Tampilkan Balasan Gemini
                removeLoading(loadingId);
                appendMessage(text, 'bot');

            } catch (error) {
                removeLoading(loadingId);
                appendMessage("Maaf, koneksi ke AI sedang gangguan atau API Key belum diset.", 'bot');
                console.error("Gemini Error:", error);
            }
        }

        // 2. Helper: Menampilkan Bubble Chat
        function appendMessage(text, sender) {
            const div = document.createElement('div');
            // Bersihkan formatting markdown sederhana (*bold*) menjadi tag <b>
            const cleanText = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'); 

            if (sender === 'user') {
                div.style.cssText = `
                    background: #763996; color: white; padding: 10px 15px; 
                    border-radius: 15px 15px 2px 15px; margin: 10px 0 10px auto; 
                    max-width: 80%; font-size: 0.9rem; align-self: flex-end;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                `;
                div.innerHTML = cleanText;
            } else {
                // Bot style
                div.className = 'bubble-bot'; 
                div.style.cssText = `
                    background: white; padding: 12px 16px; border-radius: 12px; 
                    border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
                    font-size: 0.9rem; color: #333; max-width: 85%; margin: 10px 0;
                `;
                div.innerHTML = cleanText;
            }
            
            chatBody.appendChild(div);
            chatBody.scrollTop = chatBody.scrollHeight; // Auto scroll ke bawah
        }

        // 3. Helper: Loading Indicator
        function showLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'bubble-bot';
            div.innerHTML = '<i class="fas fa-ellipsis-h fa-bounce"></i> Mengetik...';
            div.style.color = '#999';
            div.style.background = 'white';
            div.style.padding = '10px 15px';
            div.style.borderRadius = '12px';
            div.style.width = 'fit-content';
            div.style.marginBottom = '10px';
            
            chatBody.appendChild(div);
            chatBody.scrollTop = chatBody.scrollHeight;
            return id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        // 4. Event Listeners
        if(sendBtn) {
            sendBtn.addEventListener('click', handleChat);
        }
        if(chatInput) {
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleChat();
            });
        }

        // Inisialisasi Chat saat halaman dimuat
        startChat();
    </script>

</body>
</html>