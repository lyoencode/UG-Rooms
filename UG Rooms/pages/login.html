<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Dosen - UG Room</title>
    <link rel="icon" href="../assets/images/Logo-Gunadarma-Universitas-Gunadarma-Original-PNG-1140x1175 1.png" type="image/png">
    
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

    <nav class="navbar">
        <div class="container nav-container">
            <a href="../index.html" class="nav-brand">
                <img src="../assets/images/Logo gundar untuk navigation bar.png" alt="Logo Gunadarma">
            </a>

            <ul class="nav-menu">
                <li><a href="../index.html">Beranda</a></li>
                <li><a href="pesan-kelas.html">Pesan Kelas</a></li>
                <li><a href="info-kelas.html">Info Kelas</a></li>
                <li><a href="jadwal-kuliah.html">Jadwal Kuliah</a></li>
                <li><a href="bantuan.html">Bantuan</a></li>
            </ul>

            <div style="display: flex; align-items: center;">
                <div class="nav-search">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Cari Kelas...">
                </div>
                <a href="login.html" class="btn-login" style="background-color: #5a2a75;">
                    Login <i class="fas fa-sign-in-alt"></i> 
                </a>
            </div>
        </div>
    </nav>

    <section class="login-section">
        <div class="login-glass-container">
            
            <div class="login-branding">
                <img src="../assets/images/Logo-Gunadarma-Universitas-Gunadarma-Original-PNG-1140x1175 1.png" alt="Logo Besar" class="login-big-logo">
                
                <div class="login-badge">
                    <span class="text-u">U</span><span class="text-g">G</span>
                    <span style="color: #fff; font-size: 2rem; font-weight: 800; margin-left: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">Room</span>
                    <img src="../assets/images/logo ug room.png" alt="" style="height: 35px; width: auto;">
                </div>
            </div>

            <div class="login-form-card">
                <h2 class="login-title">Login Dosen</h2>
                
                <form id="loginForm" onsubmit="handleLogin(event)">
                    
                    <div class="login-input-group">
                        <label class="login-label">NIM Dosen</label>
                        <div class="input-with-icon">
                            <i class="fas fa-user input-icon-fa"></i>
                            <input type="text" id="nimInput" class="login-input" placeholder="Masukan NIM anda (8 Digit)" maxlength="8" autocomplete="off">
                        </div>
                    </div>

                    <div class="login-input-group">
                        <label class="login-label">Password</label>
                        <div class="input-with-icon">
                            <i class="fas fa-key input-icon-fa"></i>
                            <input type="password" id="passInput" class="login-input" placeholder="Masukan password anda...">
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <a href="javascript:void(0)" class="login-help-link" onclick="openLoginHelp()">Ada masalah saat login?</a>
                    </div>

                    <button type="submit" class="btn-submit-login">Log in</button>
                </form>
            </div>

        </div>
    </section>

    <button class="chat-trigger-btn" id="chatTrigger" onclick="openHelpdesk()">
        <i class="fas fa-comment-dots"></i>
    </button>

    <div class="helpdesk-widget" id="helpdeskWidget">
        
        <div class="widget-content-scroll">
            
            <div id="viewHome">
                <div class="header-home">
                    <button class="btn-header-action" onclick="closeHelpdesk()" style="position: absolute; right: 20px; top: 20px;">
                        <i class="fas fa-times"></i>
                    </button>
                    <h3 class="dash-title">Helpdesk UG ROOM</h3>
                    <p class="dash-subtitle">Waktu Operasional Senin, Rabu, Kamis, dan Jumat (05.00-14.00 WIB)</p>
                </div>

                <div class="home-overlap-container">
                    <div class="card-new-chat" onclick="goToChatRoom()">
                        <div class="card-text">
                            <h4>Percakapan Baru</h4>
                            <p>Membalas dalam beberapa menit</p>
                        </div>
                        <i class="fas fa-paper-plane icon-send-purple"></i>
                    </div>
                </div>
            </div>

            <div id="viewHistory" style="display: none;">
                <div class="header-history">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button class="btn-header-action" onclick="switchTab('home')"><i class="fas fa-chevron-left"></i></button>
                        <span>Percakapan</span>
                    </div>
                    <button class="btn-header-action" onclick="closeHelpdesk()"><i class="fas fa-times"></i></button>
                </div>

                <div class="history-container">
                    <span class="label-section">Mulai percakapan baru</span>
                    
                    <div class="card-new-chat" onclick="goToChatRoom()">
                        <div class="card-text">
                            <h4>Percakapan Baru</h4>
                            <p>Membalas dalam beberapa menit</p>
                        </div>
                        <i class="fas fa-paper-plane icon-send-purple"></i>
                    </div>

                    <span class="label-section">Terbaru</span>

                    <div class="history-item" onclick="goToChatRoom()">
                        <div class="history-item-top">
                            <span class="history-role">Helpdesk UG ROOM</span>
                            <span class="history-time">sekarang</span>
                        </div>
                        <div class="history-preview">
                            <span>Selamat datang di layanan UG...</span>
                            <i class="fas fa-chevron-right icon-arrow-right"></i>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="widget-footer" id="mainFooter">
            <button class="nav-btn active" id="btnHome" onclick="switchTab('home')">
                <i class="fas fa-home"></i>
            </button>
            <button class="nav-btn" id="btnHistory" onclick="switchTab('history')">
                <i class="far fa-comment-alt"></i>
            </button>
        </div>

        <div class="screen-chat-room" id="viewChatRoom">
            <div class="room-header">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-robot"></i> <strong>UG Room Assistant</strong>
                </div>
                <button class="btn-header-action" onclick="closeHelpdesk()"><i class="fas fa-times"></i></button>
            </div>
            <div class="room-body">
                <div class="bubble-bot">Halo! ðŸ‘‹ Ada yang bisa saya bantu?</div>
            </div>
            <div class="room-footer">
                <input type="text" class="input-chat" placeholder="Ketik pesan...">
                <button class="btn-chat-send"><i class="fas fa-paper-plane"></i></button>
            </div>
            <div style="text-align: center; padding: 10px;">
                <span style="font-size: 0.8rem; color: #999; cursor: pointer; text-decoration: underline;" onclick="exitChatRoom()">Kembali</span>
            </div>
        </div>

    </div>

    <!-- Modal Bantuan Login -->
    <div id="modal-login-help" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div style="margin-bottom: 15px;">
                <i class="fas fa-lock" style="font-size: 3rem; color: #763996;"></i>
            </div>
            <h3 style="margin-bottom: 10px; color: #333;">Kendala Login?</h3>
            <p style="color: #666; margin-bottom: 20px; font-size: 0.9rem;">
                Jika Anda lupa password atau akun terkunci, silakan hubungi <strong>Administrator BAAK</strong> atau reset melalui email kampus.
            </p>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left; font-size: 0.85rem;">
                <div style="margin-bottom: 5px;"><i class="fas fa-envelope" style="color: #763996; width: 20px;"></i> baak@staff.gunadarma.ac.id</div>
                <div><i class="fas fa-phone" style="color: #763996; width: 20px;"></i> (021) 78881112 (Ext. 303)</div>
            </div>
            <button onclick="closeLoginHelp()" class="btn-submit-login" style="width: auto; padding: 8px 30px;">Tutup</button>
        </div>
    </div>

    <script>
        // ==========================================
        // HELPDESK WIDGET LOGIC
        // ==========================================
        const viewHome = document.getElementById('viewHome');
        const viewHistory = document.getElementById('viewHistory');
        const viewChatRoom = document.getElementById('viewChatRoom');
        const btnHome = document.getElementById('btnHome');
        const btnHistory = document.getElementById('btnHistory');

        function switchTab(tab) {
            if (tab === 'home') {
                viewHome.style.display = 'block';
                viewHistory.style.display = 'none';
                btnHome.classList.add('active');
                btnHistory.classList.remove('active');
                btnHome.innerHTML = '<i class="fas fa-home"></i>';
                btnHistory.innerHTML = '<i class="far fa-comment-alt"></i>'; 
            } else {
                viewHome.style.display = 'none';
                viewHistory.style.display = 'block';
                btnHome.classList.remove('active');
                btnHistory.classList.add('active');
                btnHome.innerHTML = '<i class="fas fa-home" style="opacity:0.5"></i>';
                btnHistory.innerHTML = '<i class="fas fa-comment-alt"></i>'; 
            }
        }

        function goToChatRoom() {
            viewChatRoom.style.display = 'flex';
        }

        function exitChatRoom() {
            viewChatRoom.style.display = 'none';
            switchTab('home');
        }

        function openHelpdesk() {
            document.getElementById('chatTrigger').style.display = 'none';
            document.getElementById('helpdeskWidget').style.display = 'flex';
            switchTab('home'); 
        }

        function closeHelpdesk() {
            document.getElementById('helpdeskWidget').style.display = 'none';
            document.getElementById('chatTrigger').style.display = 'flex';
        }

        // Modal Bantuan Login
        function openLoginHelp() { 
            document.getElementById('modal-login-help').style.display = 'flex'; 
        }
        
        function closeLoginHelp() { 
            document.getElementById('modal-login-help').style.display = 'none'; 
        }
        
        window.onclick = function(e) { 
            if (e.target === document.getElementById('modal-login-help')) {
                closeLoginHelp(); 
            }
        }
    </script>

    <script>
        // ==========================================
        // SUPABASE AUTHENTICATION
        // ==========================================
        const SUPABASE_URL = 'https://maopaamqdlkrtmbrsomu.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_VI4Za4z5q9Naq9GlNOn1Bg_t7X7opLw';
        
        // âœ… PERBAIKAN: Inisialisasi yang benar
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        console.log("âœ… Supabase Client Ready:", supabaseClient);

        // ==========================================
        // HANDLE LOGIN
        // ==========================================
        async function handleLogin(event) {
            event.preventDefault();
            
            const nimVal = document.getElementById('nimInput').value.trim();
            const passVal = document.getElementById('passInput').value.trim();

            // 1. Validasi Input
            if (!nimVal || !passVal) {
                showToast("NIM dan Password wajib diisi!", "error");
                return;
            }

            // 2. Validasi Format NIM (8 digit angka)
            if (!/^\d{8}$/.test(nimVal)) {
                showToast("NIM harus berupa 8 digit angka!", "error");
                return;
            }

            // 3. Konversi NIM ke format email Gunadarma
            const emailDummy = nimVal + "@staff.gunadarma.ac.id";

            // 4. Tampilkan Loading
            const btn = document.querySelector('.btn-submit-login');
            const oldText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            btn.disabled = true;

            try {
                // 5. Login ke Supabase Auth
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: emailDummy,
                    password: passVal
                });

                if (error) throw error;

                // 6. Ambil profil user dari tabel 'profiles'
                const { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('full_name, nim, faculty')
                    .eq('id', data.user.id)
                    .single();

                if (profileError) {
                    console.warn("Profile not found, using email as name");
                }

                const displayName = profile ? profile.full_name : "Dosen";

                // 7. Simpan ke localStorage
                localStorage.setItem("isLoggedIn", "true");
                localStorage.setItem("userName", displayName);
                localStorage.setItem("userRole", "dosen");
                localStorage.setItem("userNIM", nimVal);

                // 8. Tampilkan pesan sukses
                showToast(`Login Berhasil! Halo, ${displayName}`, "success");
                
                // 9. Redirect ke halaman utama
                setTimeout(() => {
                    window.location.href = "../index.html"; 
                }, 1500);

            } catch (error) {
                console.error("Login Error:", error.message);
                showToast("NIM atau Password salah!", "error");
                
                // Reset button
                btn.innerHTML = oldText;
                btn.disabled = false;
            }
        }

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        function showToast(msg, type) {
            // Hapus toast lama jika ada
            const oldToast = document.querySelector('.toast-box');
            if (oldToast) oldToast.remove();

            // Buat toast baru
            const toast = document.createElement('div');
            toast.className = `toast-box ${type === 'success' ? 'toast-success' : 'toast-error'}`;
            
            const icon = type === 'success' 
                ? '<i class="fas fa-check-circle"></i>' 
                : '<i class="fas fa-exclamation-triangle"></i>';
            
            toast.innerHTML = `${icon} <span>${msg}</span>`;
            document.body.appendChild(toast);

            // Hilangkan setelah 3 detik
            setTimeout(() => { 
                toast.style.opacity = '0'; 
                setTimeout(() => toast.remove(), 500); 
            }, 3000);
        }

        // ==========================================
        // CEK JIKA SUDAH LOGIN
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            const isLoggedIn = localStorage.getItem("isLoggedIn");
            
            // Jika sudah login, redirect ke homepage
            if (isLoggedIn === "true") {
                window.location.href = "../index.html";
            }
        });
    </script>

    <style>
        /* Toast Notification Styles */
        .toast-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            z-index: 10000;
            opacity: 1;
            transition: opacity 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .toast-success {
            background: #4caf50;
            color: white;
        }
        
        .toast-error {
            background: #f44336;
            color: white;
        }
        
        .toast-box i {
            font-size: 1.2rem;
        }
        
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }
    </style>

</body>
</html>